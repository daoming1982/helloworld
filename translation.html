<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codex Love Dictionary</title>
    <style>
        /* åŸºç¡€å’Œå“åº”å¼å¸ƒå±€ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 600px; 
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h3 {
            color: #333; 
            text-align: center;
            margin-top: 0;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 10px;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            resize: vertical;
            font-size: 16px;
        }
        #sendBtn {
            width: 100%;
            padding: 12px;
            background-color: #4285f4; 
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #sendBtn:hover:not(:disabled) { background-color: #3367d6; }
        #sendBtn:disabled { background-color: #a0c3ff; cursor: not-allowed; }

        /* ç»“æœ/çŠ¶æ€åŒºåŸŸ */
        .result-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #e8f0fe; 
            min-height: 60px;
        }
        
        /* æ ¸å¿ƒå¯¹é½å®¹å™¨ï¼šä¸‰è¡Œæ–‡æœ¬çš„å¯¹é½æ ·å¼ï¼Œä¿æŒæ‚¨çš„è®¾è®¡ */
        .translation-container {
            display: flex;
            flex-direction: column; 
            padding: 10px 0;
            line-height: 1.5; 
        }
        .translation-line {
            font-size: 20px; 
            padding: 2px 0;
            text-align: left;
            font-family: 'Courier New', 'Lucida Console', monospace, 'Hiragino Sans GB'; 
            white-space: pre-wrap; 
        }
        #translationOutput {
            font-size: 22px; 
            color: #333;
            font-weight: 800; 
        }
        #romajiOutput {
            color: #1a73e8; 
            font-weight: normal; 
        }
        #katakanaOutput {
            color: #0f9d58; 
            font-weight: bold; 
        }
        
        #statusMessage {
            font-size: 14px;
            color: #757575;
            margin-top: 10px;
        }
        .error {
            background-color: #fce8e6; 
            color: #d93025; 
            font-weight: bold;
        }

        /* æ’­æ”¾æ§åˆ¶åŒºåŸŸ */
        .controls-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ccc;
        }
        #playBtn { 
            padding: 8px 15px;
            background-color: #fbbc05; 
            color: #333;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-grow: 1;
            margin-right: 10px;
            font-weight: bold;
        }
        #playBtn:disabled { background-color: #fcd988; cursor: not-allowed; }
        
        /* å†å²è®°å½•å¤´éƒ¨å®¹å™¨å’Œæ¸…ç©ºæŒ‰é’®æ ·å¼ */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        .history-header h4 {
            margin: 0;
            padding: 0;
            border-bottom: none; 
        }
        #clearHistoryBtn {
            padding: 5px 10px;
            background-color: #eee;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        #clearHistoryBtn:hover:not(:disabled) {
            background-color: #fce8e6;
            color: #d93025;
            border-color: #d93025;
        }
        #clearHistoryBtn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* å†å²è®°å½•æ ·å¼ */
        .history-item {
            padding: 8px;
            border-bottom: 1px dashed #eee;
            cursor: pointer;
            transition: background-color 0.1s;
            line-height: 1.4;
            position: relative; 
            display: flex; 
            align-items: center;
        }
        .history-item:hover {
            background-color: #f0f0f0;
        }

        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .delete-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #d93025; 
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            z-index: 10;
            opacity: 0.6;
            transition: opacity 0.1s;
        }
        .delete-btn:hover {
            opacity: 1;
        }
        
        /* å†å²æ’­æ”¾æŒ‰é’®æ ·å¼ (è®©ç‚¹å‡»å‘éŸ³å’ŒåŠ è½½æŸ¥è¯¢åˆ†ç¦») */
        .play-history-btn {
            position: absolute;
            right: 40px; 
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: #4285f4; 
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            z-index: 10;
            opacity: 0.8;
            transition: opacity 0.1s;
        }
        .play-history-btn:hover {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div class="container">
        <h3>Codex Love Dictionary</h3>
        <p style="text-align: center; font-size: 14px; color: #757575;">ä¸­æ–‡ â†’ æ—¥è¯­ è¯­éŸ³ç¿»è¯‘</p>
        
        <label for="inputText" style="font-weight: bold;">è¾“å…¥æ–‡æœ¬:</label>
        <textarea id="inputText" placeholder="è¾“å…¥æ‚¨æƒ³ç¿»è¯‘çš„å†…å®¹..."></textarea>
        
        <button id="sendBtn">ç¿»è¯‘å¹¶ç”Ÿæˆè¯­éŸ³</button>

        <div class="result-box">
            <div class="translation-container">
                <div id="translationOutput" class="translation-line">ç¿»è¯‘ç»“æœ (æ—¥è¯­) å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
                <div id="romajiOutput" class="translation-line"></div>
                <div id="katakanaOutput" class="translation-line"></div>
            </div>
            
            <div id="statusMessage">ç­‰å¾…è¾“å…¥...</div>
        </div>
        
        <div class="controls-group">
            <button id="playBtn" disabled>â–¶ æ’­æ”¾/å¤è¯»</button>
            
            <div class="speed-control">
                <label for="speedSelect">é€Ÿåº¦:</label>
                <select id="speedSelect">
                    <option value="0.75">æ…¢ (0.75x)</option>
                    <option value="1.0" selected>æ­£å¸¸ (1.0x)</option>
                    <option value="1.25">å¿« (1.25x)</option>
                    <option value="1.5">æ›´å¿« (1.5x)</option>
                </select>
            </div>
            
            <div class="loop-control">
                <input type="checkbox" id="loopCheckbox">
                <label for="loopCheckbox">å¾ªç¯æ’­æ”¾</label>
            </div>
        </div>

        <audio id="audioPlayer" controls></audio>
        
        <div class="history-header">
            <h4>æŸ¥è¯¢å†å²</h4>
            <button id="clearHistoryBtn" disabled>ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
        </div>

        <div id="historyContainer" style="padding: 0 5px;">
            <p id="historyStatus" style="font-size: 14px; color: #757575;">æš‚æ— å†å²è®°å½•ã€‚</p>
        </div>
    </div>

<script>
const API_URL = "https://voice.codex.love"; 
const REPEAT_DELAY_MS = 3000; 
const HISTORY_STORAGE_KEY = 'codexTranslationHistory';
const MAX_HISTORY_ITEMS = 15; 

const inputTextarea = document.getElementById("inputText");
const sendBtn = document.getElementById("sendBtn");
const playBtn = document.getElementById("playBtn");
const speedSelect = document.getElementById("speedSelect");
const loopCheckbox = document.getElementById("loopCheckbox");

const translationOutput = document.getElementById("translationOutput");
const romajiOutput = document.getElementById("romajiOutput");
const katakanaOutput = document.getElementById("katakanaOutput");

const statusMessage = document.getElementById("statusMessage");
const audioPlayer = document.getElementById("audioPlayer");
const clearHistoryBtn = document.getElementById("clearHistoryBtn"); 

let currentAudioData = null; 
let repeatTimeout = null; 

function updateStatus(message, isError = false) {
    statusMessage.textContent = message;
    statusMessage.style.color = isError ? '#d93025' : '#757575';
    statusMessage.parentNode.className = isError ? "result-box error" : "result-box";
}

function updateControls(hasAudio) {
    playBtn.disabled = !hasAudio;
    audioPlayer.style.display = hasAudio ? 'block' : 'none';
    playBtn.textContent = audioPlayer.paused ? 'â–¶ æ’­æ”¾/å¤è¯»' : 'âšâš åœæ­¢';
}

function resetUI() {
    clearTimeout(repeatTimeout);
    sendBtn.disabled = false;
    translationOutput.textContent = "ç¿»è¯‘ç»“æœ (æ—¥è¯­) å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...";
    romajiOutput.textContent = "";
    katakanaOutput.textContent = "";
    currentAudioData = null;
    audioPlayer.src = '';
    audioPlayer.loop = false;
    loopCheckbox.checked = false;
    updateControls(false); 
    updateStatus("ç­‰å¾…è¾“å…¥...", false);
}

function togglePlay() {
    if (!currentAudioData) return;
    clearTimeout(repeatTimeout); 

    if (audioPlayer.paused || audioPlayer.currentTime === 0) {
        audioPlayer.currentTime = 0; 
        audioPlayer.play();
        playBtn.textContent = 'âšâš åœæ­¢';
        updateStatus("â–¶ æ­£åœ¨æ’­æ”¾...");
    } else {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        playBtn.textContent = 'â–¶ æ’­æ”¾/å¤è¯»';
        updateStatus("â¸ å·²åœæ­¢æ’­æ”¾ã€‚");
    }
}

audioPlayer.addEventListener('ended', () => {
    if (loopCheckbox.checked) {
        updateStatus(`ğŸ”„ æ’­æ”¾ç»“æŸï¼Œç­‰å¾… ${REPEAT_DELAY_MS / 1000} ç§’åå¤è¯»...`);
        
        repeatTimeout = setTimeout(() => {
            if (loopCheckbox.checked) {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
                updateStatus("ğŸ”„ æ­£åœ¨å¤è¯»...");
            }
        }, REPEAT_DELAY_MS);
    } else {
        updateControls(true); 
        updateStatus("æ’­æ”¾ç»“æŸã€‚");
    }
});

function saveHistory(zh, jp, romaji, katakana, audioData) { 
    let history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
    
    const newRecord = { 
        zh: zh, 
        jp: jp, 
        romaji: romaji, 
        katakana: katakana,
        audio: audioData, 
        time: new Date().toLocaleString()
    };
    
    history = history.filter(record => record.zh !== zh);
    history.unshift(newRecord);
    
    if (history.length > MAX_HISTORY_ITEMS) {
        history = history.slice(0, MAX_HISTORY_ITEMS);
    }
    
    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
    renderHistory(history);
}

function loadHistory() {
    const history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
    renderHistory(history);
}

function deleteHistoryItem(index) {
    let history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
    
    if (index >= 0 && index < history.length) {
        const deletedZh = history[index].zh;
        history.splice(index, 1); 
        localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
        renderHistory(history); 
        updateStatus(`ğŸ—‘ï¸ å·²åˆ é™¤å†å²è®°å½•: "${deletedZh}"`, false);
    }
}

function clearAllHistory() {
    localStorage.removeItem(HISTORY_STORAGE_KEY);
    renderHistory([]); 
    updateStatus("ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•ã€‚", false);
    // æ¸…ç©ºå†å²åï¼Œç¡®ä¿å¯ä»¥è¿›è¡Œæ–°çš„ç¿»è¯‘
    sendBtn.disabled = false;
}


function renderHistory(history) {
    const container = document.getElementById('historyContainer');

    if (clearHistoryBtn) {
        clearHistoryBtn.disabled = history.length === 0;
    }
    
    if (history.length === 0) {
        container.innerHTML = '<p id="historyStatus" style="font-size: 14px; color: #757575;">æš‚æ— å†å²è®°å½•ã€‚</p>';
        return;
    }

    container.innerHTML = ''; 

    history.forEach((record, index) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        
        item.innerHTML = `
            <div style="padding-right: 80px;">
                <div style="font-weight: bold; color: #333;">${record.zh}</div>
                <div style="font-size: 14px; color: #555;">${record.jp}</div>
            </div>
            <span class="delete-btn" data-index="${index}" title="åˆ é™¤æ­¤è®°å½•">Ã—</span>
            <span class="play-history-btn" data-audio="${record.audio}" title="æ’­æ”¾å‘éŸ³">â–¶</span>
        `;
        
        // --- å•ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œå¤„ç†åŠ è½½ã€åˆ é™¤ã€æ’­æ”¾ ---
        item.onclick = (e) => {
            
            // 1. å¤„ç†åˆ é™¤ (Delete Button)
            if (e.target.classList.contains('delete-btn')) {
                const indexToDelete = parseInt(e.target.dataset.index);
                deleteHistoryItem(indexToDelete);
                return;
            }
            
            // 2. å¤„ç†ç‹¬ç«‹æ’­æ”¾ (Play Button)
            if (e.target.classList.contains('play-history-btn')) {
                const audioData = e.target.dataset.audio;
                if (audioData) {
                    const tempAudio = new Audio('data:audio/mp3;base64,' + audioData);
                    tempAudio.play().catch(err => console.error("æ’­æ”¾å¤±è´¥:", err));
                    updateStatus(`â–¶ æ­£åœ¨æ’­æ”¾å†å²è®°å½•: ${record.zh}`);
                } else {
                    updateStatus('âš ï¸ æ­¤è®°å½•æ²¡æœ‰éŸ³é¢‘æ•°æ®ï¼', true);
                }
                return;
            }
            
            // 3. å¤„ç†åŠ è½½è®°å½• (é»˜è®¤ç‚¹å‡»è¡Œä¸º)
            inputTextarea.value = record.zh;
            translationOutput.textContent = record.jp;
            romajiOutput.textContent = record.romaji;
            katakanaOutput.textContent = record.katakana;
            
            currentAudioData = record.audio; 
            
            // **æ ¸å¿ƒä¿®æ”¹ç‚¹ 1: åŠ è½½å†å²è®°å½•åï¼Œç¦æ­¢ä½¿ç”¨ç¿»è¯‘æŒ‰é”®**
            sendBtn.disabled = true; 
            
            // ä»…å‡†å¤‡å¥½éŸ³é¢‘ï¼Œä½†ä¸è‡ªåŠ¨æ’­æ”¾
            if (currentAudioData) {
                audioPlayer.src = 'data:audio/mp3;base64,' + currentAudioData;
                audioPlayer.currentTime = 0;
                updateControls(true); 
                updateStatus(`âœ… å·²ä»å†å²è®°å½•åŠ è½½: ${record.zh} (å‡†å¤‡å°±ç»ª)`);
            } else {
                audioPlayer.src = '';
                updateControls(false); 
                updateStatus(`âš ï¸ å·²ä»å†å²è®°å½•åŠ è½½: ${record.zh} (æ— éŸ³é¢‘)`, true);
            }
            window.scrollTo(0, 0); 
        };
        
        container.appendChild(item);
    });
}


sendBtn.addEventListener("click", async () => {
    const input = inputTextarea.value.trim();
    if (!input) {
        updateStatus("è¯·è¾“å…¥å†…å®¹ï¼", true);
        return;
    }

    sendBtn.disabled = true;
    updateStatus("æ­£åœ¨å¤„ç†...", false);
    translationOutput.textContent = "ç¿»è¯‘ä¸­...";
    romajiOutput.textContent = "";
    katakanaOutput.textContent = "";
    currentAudioData = null; 
    updateControls(false); 
    audioPlayer.pause();
    
    try {
        const resp = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: input })
        });

        const data = await resp.json();
        
        if (!resp.ok || data.error) {
            let errorMsg = `API é”™è¯¯: ${data.error || 'è¿æ¥å¤±è´¥'}`;
            if (data.status && data.status >= 400) { errorMsg += ` (é”™è¯¯ä»£ç : ${data.status})`; }
            if (data.status === 403) { errorMsg += "\nğŸš¨ é”™è¯¯è¯Šæ–­ï¼šè¯·æ£€æŸ¥æœåŠ¡å‡­è¯é™åˆ¶ã€‚"; }
            
            translationOutput.textContent = "ç¿»è¯‘å¤±è´¥ã€‚";
            updateStatus(errorMsg, true);
            return;
        }

        const translation = data.translation || "æœªè·å–ç¿»è¯‘ç»“æœ";
        const romaji = data.romaji || "";
        const katakana = data.katakana || "";
        currentAudioData = data.audio; 
        
        translationOutput.textContent = translation; 
        romajiOutput.textContent = romaji;
        katakanaOutput.textContent = katakana;
        
        if (currentAudioData) {
            const audioSrc = 'data:audio/mp3;base64,' + currentAudioData;
            audioPlayer.src = audioSrc;
            
            audioPlayer.currentTime = 0; 
            audioPlayer.play(); 
            
            updateControls(true); 
            updateStatus(`âœ… æˆåŠŸï¼éŸ³é¢‘æ­£åœ¨æ’­æ”¾ã€‚`);
        } else {
            updateStatus(`âš ï¸ æˆåŠŸå“åº”ï¼Œä½†æœªè¿”å›éŸ³é¢‘æ•°æ®ã€‚ç¿»è¯‘ç»“æœ: ${translation}`, true);
            updateControls(false);
        }
        
        saveHistory(input, translation, romaji, katakana, currentAudioData); 

    } catch (err) {
        translationOutput.textContent = "ç½‘ç»œè¿æ¥å¤±è´¥ã€‚";
        updateStatus(`âŒ ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ° ${API_URL}ã€‚`, true);
    } finally {
        // API è°ƒç”¨ç»“æŸåï¼Œé‡æ–°å¯ç”¨æŒ‰é’®
        sendBtn.disabled = false;
    }
});

// **æ ¸å¿ƒä¿®æ”¹ç‚¹ 2: ç›‘å¬è¾“å…¥æ¡†ï¼Œåªè¦ç”¨æˆ·å¼€å§‹ç¼–è¾‘ï¼Œå°±é‡æ–°å¯ç”¨ç¿»è¯‘æŒ‰é’®**
inputTextarea.addEventListener('input', () => {
    // åªè¦ç”¨æˆ·å¼€å§‹ä¿®æ”¹æˆ–è¾“å…¥æ–‡æœ¬ï¼Œå°±å…è®¸å†æ¬¡ç¿»è¯‘
    sendBtn.disabled = false;
});

// --- å…¶ä»–äº‹ä»¶ç›‘å¬å™¨ ---
playBtn.addEventListener('click', togglePlay);
speedSelect.addEventListener('change', () => { audioPlayer.playbackRate = parseFloat(speedSelect.value); });
loopCheckbox.addEventListener('change', () => {
    audioPlayer.loop = false; 
    if (loopCheckbox.checked && audioPlayer.paused && currentAudioData) { togglePlay(); }
    updateStatus(loopCheckbox.checked ? "ğŸ”„ å·²å¼€å¯ 3 ç§’é—´éš”å¾ªç¯ã€‚" : "â–¶ å¾ªç¯æ’­æ”¾å·²å…³é—­ã€‚", false);
});
audioPlayer.addEventListener('play', () => { playBtn.textContent = 'âšâš åœæ­¢'; clearTimeout(repeatTimeout); });
audioPlayer.addEventListener('pause', () => { playBtn.textContent = 'â–¶ æ’­æ”¾/å¤è¯»'; clearTimeout(repeatTimeout); });
clearHistoryBtn.addEventListener('click', clearAllHistory);


document.addEventListener("DOMContentLoaded", () => {
    audioPlayer.playbackRate = parseFloat(speedSelect.value);
    resetUI();
    loadHistory(); 
});
</script>

</body>
</html>