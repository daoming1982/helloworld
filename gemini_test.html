<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codex Love Dictionary</title>
    <style>
        /* åŸºç¡€å’Œå“åº”å¼å¸ƒå±€ (ä¿æŒä¸€è‡´) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 600px; 
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h3 {
            color: #333; 
            text-align: center;
            margin-top: 0;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 10px;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            resize: vertical;
            font-size: 16px;
        }
        #sendBtn {
            width: 100%;
            padding: 12px;
            background-color: #4285f4; 
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #sendBtn:hover:not(:disabled) { background-color: #3367d6; }
        #sendBtn:disabled { background-color: #a0c3ff; cursor: not-allowed; }

        /* ç»“æœ/çŠ¶æ€åŒºåŸŸ */
        .result-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #e8f0fe; 
            min-height: 60px;
        }
        
        /* æ ¸å¿ƒå¯¹é½å®¹å™¨ï¼šä½¿ç”¨ Flexbox å®ç°ä¸‰è¡Œæ–‡æœ¬çš„å¯¹é½ */
        .translation-container {
            display: flex;
            flex-direction: column; /* å‚ç›´å †å ä¸‰è¡Œ */
            padding: 10px 0;
            white-space: pre-wrap; /* ä¿æŒæ¢è¡Œå’Œç©ºæ ¼ */
        }

        /* æ¯ä¸€è¡Œæ–‡æœ¬çš„é€šç”¨æ ·å¼ */
        .translation-line {
            line-height: 1.4;
            padding: 2px 0;
            text-align: left;
            /* å¼ºåˆ¶ç­‰å®½å­—ä½“ï¼Œæœ‰åŠ©äºè§†è§‰å¯¹é½ï¼Œå°¤å…¶å½“Workeråœ¨æ¯ä¸ªè¯ä¹‹é—´ç•™æœ‰ç©ºæ ¼æ—¶ */
            font-family: 'Courier New', 'Lucida Console', monospace, 'Hiragino Sans GB'; 
        }

        /* 1. æ—¥è¯­ç¿»è¯‘ (ä¸»æ–‡æœ¬) */
        #translationOutput {
            font-size: 24px;
            color: #333;
            font-weight: bold; /* åŠ ç²— */
            font-family: 'Hiragino Sans GB', 'Meiryo', 'Yu Gothic', sans-serif; /* ä½¿ç”¨éç­‰å®½å­—ä½“ï¼Œçªå‡ºä¸»è¦æ–‡å­— */
        }

        /* 2. ç½—é©¬éŸ³ */
        #romajiOutput {
            font-size: 18px;
            color: #1a73e8; /* è“è‰² */
            font-style: italic; /* æ–œä½“ */
            font-weight: normal; 
        }

        /* 3. ç‰‡å‡å */
        #katakanaOutput {
            font-size: 18px;
            color: #0f9d58; /* ç»¿è‰² */
            font-weight: 600; /* ä¸­ç­‰åŠ ç²— */
        }
        
        #statusMessage {
            font-size: 14px;
            color: #757575;
            margin-top: 10px;
        }
        .error {
            background-color: #fce8e6; 
            color: #d93025; 
            font-weight: bold;
        }

        /* æ’­æ”¾æ§åˆ¶åŒºåŸŸ (æ ·å¼ä¸å˜) */
        .controls-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ccc;
        }
        #playBtn { 
            padding: 8px 15px;
            background-color: #fbbc05; 
            color: #333;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-grow: 1;
            margin-right: 10px;
            font-weight: bold;
        }
        #playBtn:disabled { background-color: #fcd988; cursor: not-allowed; }
        .speed-control, .loop-control { display: flex; align-items: center; }
        .speed-control { margin-right: 10px; }
        .speed-control label, .loop-control label { font-size: 14px; margin-right: 5px; color: #555; }
        #speedSelect { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        #audioPlayer { width: 100%; margin-top: 15px; display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h3>Codex Love Dictionary</h3>
        <p style="text-align: center; font-size: 14px; color: #757575;">ä¸­æ–‡ â†’ æ—¥è¯­ è¯­éŸ³ç¿»è¯‘</p>
        
        <label for="inputText" style="font-weight: bold;">è¾“å…¥æ–‡æœ¬:</label>
        <textarea id="inputText" placeholder="è¾“å…¥æ‚¨æƒ³ç¿»è¯‘çš„å†…å®¹..."></textarea>
        
        <button id="sendBtn">ç¿»è¯‘å¹¶ç”Ÿæˆè¯­éŸ³</button>

        <div class="result-box">
            <div class="translation-container">
                <div id="translationOutput" class="translation-line">ç¿»è¯‘ç»“æœ (æ—¥è¯­) å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
                
                <div id="romajiOutput" class="translation-line"></div>
                
                <div id="katakanaOutput" class="translation-line"></div>
            </div>
            
            <div id="statusMessage">ç­‰å¾…è¾“å…¥...</div>
        </div>
        
        <div class="controls-group">
            <button id="playBtn" disabled>â–¶ æ’­æ”¾/å¤è¯»</button>
            
            <div class="speed-control">
                <label for="speedSelect">é€Ÿåº¦:</label>
                <select id="speedSelect">
                    <option value="0.75">æ…¢ (0.75x)</option>
                    <option value="1.0" selected>æ­£å¸¸ (1.0x)</option>
                    <option value="1.25">å¿« (1.25x)</option>
                    <option value="1.5">æ›´å¿« (1.5x)</option>
                </select>
            </div>
            
            <div class="loop-control">
                <input type="checkbox" id="loopCheckbox">
                <label for="loopCheckbox">å¾ªç¯æ’­æ”¾</label>
            </div>
        </div>

        <audio id="audioPlayer" controls></audio>
    </div>

<script>
const API_URL = "https://voice.codex.love"; 
const REPEAT_DELAY_MS = 3000; // 3ç§’å¤è¯»é—´éš”

const inputTextarea = document.getElementById("inputText");
const sendBtn = document.getElementById("sendBtn");
const playBtn = document.getElementById("playBtn");
const speedSelect = document.getElementById("speedSelect");
const loopCheckbox = document.getElementById("loopCheckbox");

const translationOutput = document.getElementById("translationOutput");
const romajiOutput = document.getElementById("romajiOutput");
const katakanaOutput = document.getElementById("katakanaOutput");

const statusMessage = document.getElementById("statusMessage");
const audioPlayer = document.getElementById("audioPlayer");

let currentAudioData = null; 
let repeatTimeout = null; 

function updateStatus(message, isError = false) {
    statusMessage.textContent = message;
    statusMessage.style.color = isError ? '#d93025' : '#757575';
    statusMessage.parentNode.className = isError ? "result-box error" : "result-box";
}

function updateControls(hasAudio) {
    playBtn.disabled = !hasAudio;
    audioPlayer.style.display = hasAudio ? 'block' : 'none';
    playBtn.textContent = audioPlayer.paused ? 'â–¶ æ’­æ”¾/å¤è¯»' : 'âšâš åœæ­¢';
}

function resetUI() {
    clearTimeout(repeatTimeout);
    sendBtn.disabled = false;
    translationOutput.textContent = "ç¿»è¯‘ç»“æœ (æ—¥è¯­) å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...";
    romajiOutput.textContent = "";
    katakanaOutput.textContent = "";
    currentAudioData = null;
    audioPlayer.src = '';
    audioPlayer.loop = false;
    loopCheckbox.checked = false;
    updateControls(false); 
    updateStatus("ç­‰å¾…è¾“å…¥...", false);
}

// æ’­æ”¾/å¤è¯» æ ¸å¿ƒåŠŸèƒ½ (ä¿æŒä¸å˜)
function togglePlay() {
    if (!currentAudioData) return;
    clearTimeout(repeatTimeout); 

    if (audioPlayer.paused || audioPlayer.currentTime === 0) {
        audioPlayer.currentTime = 0; 
        audioPlayer.play();
        playBtn.textContent = 'âšâš åœæ­¢';
        updateStatus("â–¶ æ­£åœ¨æ’­æ”¾...");
    } else {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        playBtn.textContent = 'â–¶ æ’­æ”¾/å¤è¯»';
        updateStatus("â¸ å·²åœæ­¢æ’­æ”¾ã€‚");
    }
}

// ç›‘å¬éŸ³é¢‘æ’­æ”¾ç»“æŸ (ä¿æŒä¸å˜)
audioPlayer.addEventListener('ended', () => {
    if (loopCheckbox.checked) {
        updateStatus(`ğŸ”„ æ’­æ”¾ç»“æŸï¼Œç­‰å¾… ${REPEAT_DELAY_MS / 1000} ç§’åå¤è¯»...`);
        
        repeatTimeout = setTimeout(() => {
            if (loopCheckbox.checked) {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
                updateStatus("ğŸ”„ æ­£åœ¨å¤è¯»...");
            }
        }, REPEAT_DELAY_MS);
    } else {
        updateControls(true); 
        updateStatus("æ’­æ”¾ç»“æŸã€‚");
    }
});


// æ ¸å¿ƒåŠŸèƒ½ï¼šå‘é€ API è¯·æ±‚å¹¶è·å–éŸ³é¢‘ (ä¿æŒä¸å˜)
sendBtn.addEventListener("click", async () => {
    const input = inputTextarea.value.trim();
    if (!input) {
        updateStatus("è¯·è¾“å…¥å†…å®¹ï¼", true);
        return;
    }

    sendBtn.disabled = true;
    updateStatus("æ­£åœ¨å¤„ç†...", false);
    translationOutput.textContent = "ç¿»è¯‘ä¸­...";
    romajiOutput.textContent = "";
    katakanaOutput.textContent = "";
    currentAudioData = null; 
    updateControls(false); 
    audioPlayer.pause();
    
    try {
        const resp = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: input })
        });

        const data = await resp.json();
        
        if (!resp.ok || data.error) {
            let errorMsg = `API é”™è¯¯: ${data.error || 'è¿æ¥å¤±è´¥'}`;
            if (data.status && data.status >= 400) { errorMsg += ` (é”™è¯¯ä»£ç : ${data.status})`; }
            if (data.status === 403) { errorMsg += "\nğŸš¨ é”™è¯¯è¯Šæ–­ï¼šè¯·æ£€æŸ¥æœåŠ¡å‡­è¯é™åˆ¶ã€‚"; }
            
            translationOutput.textContent = "ç¿»è¯‘å¤±è´¥ã€‚";
            updateStatus(errorMsg, true);
            return;
        }

        // æˆåŠŸå“åº”
        const translation = data.translation || "æœªè·å–ç¿»è¯‘ç»“æœ";
        const romaji = data.romaji || "";
        const katakana = data.katakana || "";
        currentAudioData = data.audio; 
        
        // ğŸš¨ å…³é”®ï¼šç›´æ¥å°† Worker è¿”å›çš„ä¸‰ä¸ªé•¿å­—ç¬¦ä¸²æ”¾å…¥å„è‡ªçš„ div ä¸­
        translationOutput.textContent = translation; 
        romajiOutput.textContent = romaji;
        katakanaOutput.textContent = katakana;
        
        if (currentAudioData) {
            const audioSrc = 'data:audio/mp3;base64,' + currentAudioData;
            audioPlayer.src = audioSrc;
            
            audioPlayer.currentTime = 0; 
            audioPlayer.play(); 
            
            updateControls(true); 
            updateStatus(`âœ… æˆåŠŸï¼éŸ³é¢‘æ­£åœ¨æ’­æ”¾ã€‚`);
        } else {
            updateStatus(`âš ï¸ æˆåŠŸå“åº”ï¼Œä½†æœªè¿”å›éŸ³é¢‘æ•°æ®ã€‚ç¿»è¯‘ç»“æœ: ${translation}`, true);
            updateControls(false);
        }

    } catch (err) {
        translationOutput.textContent = "ç½‘ç»œè¿æ¥å¤±è´¥ã€‚";
        updateStatus(`âŒ ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ° ${API_URL}ã€‚`, true);
    } finally {
        sendBtn.disabled = false;
    }
});

// --- å…¶ä»–äº‹ä»¶ç›‘å¬å™¨ (ä¿æŒä¸å˜) ---
playBtn.addEventListener('click', togglePlay);
speedSelect.addEventListener('change', () => { audioPlayer.playbackRate = parseFloat(speedSelect.value); });
loopCheckbox.addEventListener('change', () => {
    audioPlayer.loop = false; 
    if (loopCheckbox.checked && audioPlayer.paused && currentAudioData) { togglePlay(); }
    updateStatus(loopCheckbox.checked ? "ğŸ”„ å·²å¼€å¯ 3 ç§’é—´éš”å¾ªç¯ã€‚" : "â–¶ å¾ªç¯æ’­æ”¾å·²å…³é—­ã€‚", false);
});
audioPlayer.addEventListener('play', () => { playBtn.textContent = 'âšâš åœæ­¢'; clearTimeout(repeatTimeout); });
audioPlayer.addEventListener('pause', () => { playBtn.textContent = 'â–¶ æ’­æ”¾/å¤è¯»'; clearTimeout(repeatTimeout); });

document.addEventListener("DOMContentLoaded", () => {
    audioPlayer.playbackRate = parseFloat(speedSelect.value);
    resetUI();
});
</script>

</body>
</html>